#!/usr/bin/env node

/**
 * Module dependencies.
 */


import net from 'net'
import app from '../app.js'

const getAvailablePort = (targetPort) => {
  return new Promise((resolve, reject) => {
    const server =  net.createServer()
    
    server.listen(targetPort, () => {
      const port = server.address().port
      server.close()
      resolve(port)
    })
    server.on('error', (err) => {
      if (err.code === 'EADDRINUSE') {
        getAvailablePort(targetPort + 1).then((port) => {
          resolve(port)
        }).catch(reject)
      } else {
        reject(err)
      }
    })
  })}

getAvailablePort(3000).then((port) => {
  app.set('port', port)
  app.listen(port, () => {
    console.log(`Listening on port ${port}`)
  })
}).catch((err) => {
  console.error(err)
  process.exit(1)
})
  